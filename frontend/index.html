<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DRISHTI-SHIELD | AI GEOINT Assistant</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet.js (Map Library) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Leaflet-Draw Plugin (for drawing AOI) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

    <style>
        /* Custom styles for Leaflet */
        .leaflet-container { background: #1a202c; }
        .leaflet-draw-toolbar a { background-color: #2d3748 !important; color: #e2e8f0 !important; }
        .leaflet-draw-draw-rectangle { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M3 3v18h18V3H3zm16 16H5V5h14v14z"/></svg>') !important; }
        .modal { transition: opacity 0.25s ease; }
        .modal-content { transition: transform 0.25s ease; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex h-screen overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-96 h-screen bg-gray-800 shadow-2xl flex flex-col z-20">
        <!-- Header -->
        <div class="p-4 border-b border-gray-700">
            <h1 class="text-2xl font-bold text-white">DRISHTI-SHIELD</h1>
            <p class="text-sm text-cyan-400">AI Geospatial Intelligence Assistant</p>
        </div>

        <!-- Controls -->
        <div class="p-4 space-y-4">
            <p class="text-gray-400 text-sm">
                <span class="font-bold text-cyan-400">Step 1:</span> Use the draw tool 
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4 inline-block -mt-1"><path d="M3 3v18h18V3H3zm16 16H5V5h14v14z"></path></svg>
                on the map to select an Area of Interest (AOI).
            </p>
            <p class="text-gray-400 text-sm">
                <span class="font-bold text-cyan-400">Step 2:</span> Click 'Analyze' to run the AI pipeline on that specific region.
            </p>

            <button id="analyze-btn" class="w-full bg-cyan-600 text-white font-bold py-3 rounded-lg hover:bg-cyan-500 transition duration-300 shadow-lg opacity-50 cursor-not-allowed" disabled>
                Analyze Selected AOI
            </button>
        </div>

        <!-- Results Panel (Dynamic) -->
        <div id="results-panel" class="flex-1 overflow-y-auto p-4 border-t border-gray-700 hidden">
            <h2 class="text-xl font-bold text-white mb-3">Analysis Complete</h2>
            <div class="bg-gray-700 p-3 rounded-lg">
                <h3 class="font-semibold text-cyan-400">Risk Assessment</h3>
                <p id="risk-score" class="text-2xl font-bold text-red-500"></p>
            </div>
            
            <div class="mt-4">
                <h3 class="font-semibold text-cyan-400">Key Detections</h3>
                <ul id="detections-list" class="list-disc list-inside text-sm text-gray-300 space-y-1 mt-2">
                    <!-- Detections will be populated here -->
                </ul>
            </div>

            <button id="show-report-btn" class="w-full bg-gray-600 text-white font-semibold py-2 rounded-lg hover:bg-gray-500 transition duration-300 mt-4">
                View Full LLM Report
            </button>
        </div>

        <!-- Loading Spinner -->
        <div id="loading-spinner" class="flex-1 p-4 border-t border-gray-700 flex flex-col items-center justify-center hidden">
            <svg class="animate-spin h-12 w-12 text-cyan-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-lg font-semibold text-gray-300 mt-4">Running AI Analysis...</p>
            <p class="text-sm text-gray-400">This may take a moment.</p>
        </div>
    </aside>

    <!-- Map Container -->
    <main class="flex-1 h-screen z-10">
        <div id="map" class="h-full w-full"></div>
    </main>

    <!-- LLM Report Modal -->
    <div id="report-modal" class="modal fixed inset-0 z-30 flex items-center justify-center bg-black bg-opacity-75 opacity-0 pointer-events-none">
        <div class="modal-content bg-gray-800 text-gray-200 rounded-lg shadow-2xl w-full max-w-3xl p-6 transform scale-95">
            <div class="flex items-center justify-between pb-3 border-b border-gray-700">
                <h2 class="text-2xl font-bold text-white">Full Intelligence Report</h2>
                <button id="close-report-btn" class="text-gray-400 hover:text-white">&times;</button>
            </div>
            <div class="mt-4 max-h-96 overflow-y-auto">
                <pre id="llm-report-content" class="text-sm text-gray-300 whitespace-pre-wrap font-sans"></pre>
            </div>
        </div>
    </div>

    <script>
        // --- Globals ---
        let map;
        let drawnItems;
        let aoiBounds = null; // Stores the Lat/Lng bounds of the AOI
        let resultLayers = new L.LayerGroup(); // Holds anomalies and mask

        // --- DOM Elements ---
        const analyzeBtn = document.getElementById('analyze-btn');
        const resultsPanel = document.getElementById('results-panel');
        const loadingSpinner = document.getElementById('loading-spinner');
        const riskScoreEl = document.getElementById('risk-score');
        const detectionsListEl = document.getElementById('detections-list');
        const showReportBtn = document.getElementById('show-report-btn');
        const reportModal = document.getElementById('report-modal');
        const closeReportBtn = document.getElementById('close-report-btn');
        const llmReportContent = document.getElementById('llm-report-content');

        // --- Initialize Map ---
        function initMap() {
            map = L.map('map').setView([28.6139, 77.2090], 5); // Default to New Delhi
            
            // Base Layer (Dark)
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 20
            }).addTo(map);

            // --- REAL SATELLITE LAYER ---
            // NASA GIBS satellite imagery layer
            const nasaViirsLayer = L.tileLayer('https://map1.vis.earthdata.nasa.gov/wmts-webmerc/VIIRS_SNPP_CorrectedReflectance_TrueColor/default/{time}/{tilematrixset}{maxZoom}/{z}/{y}/{x}.{format}', {
                attribution: 'NASA GIBS | VIIRS',
                bounds: [[-85.0511287776, -179.999999975], [85.0511287776, 179.999999975]],
                minZoom: 1,
                maxZoom: 9,
                format: 'jpg',
                time: '2025-10-29', // Can be dynamic, but static is fine for demo
                tilematrixset: 'GoogleMapsCompatible_Level'
            });

            // Layer Controls
            const baseLayers = {
                "Dark Map": L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map),
                "Standard Map": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'),
                "NASA Satellite (VIIRS)": nasaViirsLayer
            };
            L.control.layers(baseLayers).addTo(map);

            // --- Initialize Draw Controls ---
            drawnItems = new L.FeatureGroup();
            map.addLayer(drawnItems);
            map.addLayer(resultLayers);

            const drawControl = new L.Control.Draw({
                draw: {
                    polygon: false,
                    polyline: false,
                    circle: false,
                    circlemarker: false,
                    marker: false,
                    rectangle: {
                        shapeOptions: {
                            color: '#00ffff', // Cyan
                            weight: 3,
                            fillOpacity: 0.1
                        }
                    }
                },
                edit: {
                    featureGroup: drawnItems,
                    remove: false,
                    edit: false
                }
            });
            map.addControl(drawControl);

            // --- Map Event Handlers ---
            map.on(L.Draw.Event.CREATED, (event) => {
                // User finished drawing a rectangle
                drawnItems.clearLayers(); // Clear previous AOI
                resultLayers.clearLayers(); // Clear previous results
                
                const layer = event.layer;
                drawnItems.addLayer(layer);
                
                // Get the Lat/Lng bounds
                aoiBounds = layer.getBounds();
                
                // Enable the analyze button
                analyzeBtn.disabled = false;
                analyzeBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                resultsPanel.classList.add('hidden');
            });
        }

        // --- API Call ---
        async function handleAnalysis() {
            if (!aoiBounds) {
                alert("Please draw an Area of Interest (AOI) on the map first.");
                return;
            }

            // Show loading spinner, hide results
            loadingSpinner.classList.remove('hidden');
            resultsPanel.classList.add('hidden');
            analyzeBtn.disabled = true;
            analyzeBtn.classList.add('opacity-50', 'cursor-not-allowed');
            resultLayers.clearLayers();

            const payload = {
                aoi_bounds: {
                    north_east: aoiBounds.getNorthEast(), // {lat, lng}
                    south_west: aoiBounds.getSouthWest()  // {lat, lng}
                }
            };
            
            try {
                const response = await fetch('http://127.0.0.1:8000/api/v1/analyze_aoi', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    // The server returned an error
                    const errorText = await response.text();
                    let errorDetail = "Analysis failed on server.";
                    try {
                        const errJson = JSON.parse(errorText);
                        if (errJson.detail) {
                            errorDetail = errJson.detail;
                        } else {
                            errorDetail = errorText;
                        }
                    } catch (e) {
                        errorDetail = errorText;
                    }
                    throw new Error(`Server error (${response.status}): ${errorDetail}`);
                }

                const data = await response.json();
                displayResults(data);

            } catch (error) {
                console.error("Analysis Error:", error);
                let friendlyMessage = error.message;
                if (error.message.includes("Failed to fetch") || error.message.includes("Load failed")) {
                    friendlyMessage = "Could not connect to the DRISHTI-SHIELD API server.\n\n" +
                                      "Please ensure the 'api_server.py' is running in your terminal.";
                }
                alert(`Analysis Failed: ${friendlyMessage}`);
            } finally {
                // Hide loading spinner
                loadingSpinner.classList.add('hidden');
                analyzeBtn.disabled = false;
                analyzeBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        // --- Display Results ---
        function displayResults(data) {
            // Show the results panel
            resultsPanel.classList.remove('hidden');

            // 1. Populate sidebar
            riskScoreEl.textContent = data.risk_score.toFixed(1) + " / 10.0";
            detectionsListEl.innerHTML = ''; // Clear old list
            data.fused_data.forEach(item => {
                const li = document.createElement('li');
                li.textContent = `${item.class} (${item.type})`;
                detectionsListEl.appendChild(li);
            });

            // 2. Populate LLM Report Modal
            llmReportContent.textContent = data.report_summary;

            // 3. Add results to map
            const imageBounds = [
                [data.image_bounds.south_west.lat, data.image_bounds.south_west.lng],
                [data.image_bounds.north_east.lat, data.image_bounds.north_east.lng]
            ];
            
            // Add change mask overlay
            const changeMaskOverlay = L.imageOverlay(data.change_mask_url, imageBounds, {
                opacity: 0.7,
                interactive: false
            });
            resultLayers.addLayer(changeMaskOverlay);

            // Add GeoJSON anomalies
            const anomaliesLayer = L.geoJSON(data.anomalies_geojson, {
                pointToLayer: (feature, latlng) => {
                    // Style as a red circle
                    return L.circleMarker(latlng, {
                        radius: 8,
                        fillColor: "#f03",
                        color: "#fff",
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8
                    });
                },
                onEachFeature: (feature, layer) => {
                    // Add popup
                    const props = feature.properties;
                    layer.bindPopup(
                        `<h4 style="font-weight:bold;color:#333;">Anomaly Detected</h4>
                         <p><b>Type:</b> ${props.type}</p>
                         <p><b>Class:</b> ${props.class}</p>
                         <p><b>Confidence:</b> ${props.confidence.toFixed(2)}</p>`
                    );
                }
            });
            resultLayers.addLayer(anomaliesLayer);
        }

        // --- Modal Controls ---
        function toggleModal(show) {
            if (show) {
                reportModal.classList.remove('opacity-0', 'pointer-events-none');
                reportModal.firstElementChild.classList.remove('scale-95');
            } else {
                reportModal.classList.add('opacity-0', 'pointer-events-none');
                reportModal.firstElementChild.classList.add('scale-95');
            }
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', initMap);
        analyzeBtn.addEventListener('click', handleAnalysis);
        showReportBtn.addEventListener('click', () => toggleModal(true));
        closeReportBtn.addEventListener('click', () => toggleModal(false));
        reportModal.addEventListener('click', (e) => {
            if (e.target === reportModal) toggleModal(false); // Close on bg click
        });

    </script>
</body>
</html>
